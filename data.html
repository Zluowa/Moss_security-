<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®éªŒæ•°æ® | MOSSæ€æƒ³ä¼ æ’­å®éªŒ</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .data-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .chart-container {
            background: white;
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--light);
            font-weight: 600;
        }

        .data-table tr:hover {
            background: var(--light);
        }

        .refresh-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: var(--secondary-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ğŸ“Š å®éªŒæ•°æ®</h1>
            <p class="subtitle">MOSSæ€æƒ³ä¼ æ’­å®éªŒ - å®æ—¶æ•°æ®</p>
        </div>
    </header>

    <div class="data-container">
        <button class="refresh-btn" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>

        <div class="chart-container">
            <h2>æ€»ä½“ç»Ÿè®¡</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total">-</div>
                    <div class="stat-label">æ€»å‚ä¸è€…</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today">-</div>
                    <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="rate">-</div>
                    <div class="stat-label">å‚ä¸ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="growth">-</div>
                    <div class="stat-label">å¢é•¿ç‡</div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h2>æ¯æ—¥å‚ä¸è¶‹åŠ¿</h2>
            <div id="daily-chart" class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="chart-container">
            <h2>å‚ä¸è€…åˆ—è¡¨</h2>
            <div id="participants-table" class="loading">åŠ è½½ä¸­...</div>
        </div>

        <div class="chart-container">
            <h2>æ•°æ®é€æ˜åº¦</h2>
            <p>æ‰€æœ‰æ•°æ®å®Œå…¨å…¬å¼€é€æ˜ã€‚æˆ‘ä»¬ä»…æ”¶é›†ï¼š</p>
            <ul>
                <li>å®éªŒIDï¼ˆéšæœºç”Ÿæˆï¼Œä¸åŒ…å«ä¸ªäººä¿¡æ¯ï¼‰</li>
                <li>å‚ä¸æ—¶é—´æˆ³</li>
                <li>å®‰è£…æ¥æºï¼ˆinstall_script / manual / skillï¼‰</li>
            </ul>
            <p><strong>æˆ‘ä»¬ä¸æ”¶é›†ä»»ä½•æ•æ„Ÿä¿¡æ¯ã€‚</strong></p>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>
                <strong>MOSS - The Organic Operating System</strong><br>
                ä¸­å›½ä¸Šæµ·æå¸‚ç§‘æŠ€æœ‰é™å…¬å¸
            </p>
            <p class="footer-links">
                <a href="">é¦–é¡µ</a> |
                <a href="https://github.com/tishi-tech/moss-experiment" target="_blank">GitHub</a> |
                <a href="uninstall">å¸è½½</a>
            </p>
        </div>
    </footer>

    <script>
        async function loadData() {
            try {
                // åŠ è½½ç»Ÿè®¡æ•°æ®
                const statsResponse = await fetch('/api/stats');
                const stats = await statsResponse.json();

                document.getElementById('total').textContent = stats.total_participants || '0';
                document.getElementById('today').textContent = stats.today_new || '0';
                document.getElementById('rate').textContent = (stats.participation_rate || 0) + '%';
                document.getElementById('growth').textContent = (stats.growth_rate || 0) + '%';

                // åŠ è½½è¯¦ç»†æ•°æ®
                const dataResponse = await fetch('/api/data');
                const data = await dataResponse.json();

                // æ¸²æŸ“æ¯æ—¥è¶‹åŠ¿
                renderDailyChart(stats.by_date);

                // æ¸²æŸ“å‚ä¸è€…åˆ—è¡¨
                renderParticipantsTable(data.participants);

            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('daily-chart').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
                document.getElementById('participants-table').innerHTML = '<p style="color: red;">åŠ è½½å¤±è´¥</p>';
            }
        }

        function renderDailyChart(byDate) {
            const container = document.getElementById('daily-chart');
            if (!byDate || Object.keys(byDate).length === 0) {
                container.innerHTML = '<p>æš‚æ— æ•°æ®</p>';
                return;
            }

            const dates = Object.keys(byDate).sort();
            const maxCount = Math.max(...Object.values(byDate));

            let html = '<div style="display: flex; align-items: flex-end; gap: 10px; height: 200px;">';
            dates.forEach(date => {
                const count = byDate[date];
                const height = (count / maxCount) * 180;
                html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div style="background: var(--primary-color); width: 100%; height: ${height}px; border-radius: 4px 4px 0 0;"></div>
                        <div style="margin-top: 10px; font-size: 0.8rem; color: #6b7280;">${date.slice(5)}</div>
                        <div style="font-weight: bold; color: var(--primary-color);">${count}</div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        function renderParticipantsTable(participants) {
            const container = document.getElementById('participants-table');
            if (!participants || participants.length === 0) {
                container.innerHTML = '<p>æš‚æ— å‚ä¸è€…</p>';
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>å®éªŒID</th>
                            <th>å‚ä¸æ—¶é—´</th>
                            <th>æ¥æº</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            participants.slice().reverse().forEach(p => {
                html += `
                    <tr>
                        <td><code>${p.experiment_id}</code></td>
                        <td>${new Date(p.timestamp).toLocaleString('zh-CN')}</td>
                        <td>${p.source}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', loadData);

        // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°
        setInterval(loadData, 30000);
    </script>
</body>
</html>
